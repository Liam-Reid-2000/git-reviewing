name: PR Review Reminder
# Run at 8:30am-4:30pm GMT, Mon-Fri (9:30am-5:30pm during BST)
# To change in Summer time, need to update manually.
# Can create an external scheduler if we don't want to manually update.
on:
  schedule:
    - cron: "30 8-16 * * 1-5" # Hourly 8:30am-4:30pm UTC
  workflow_dispatch:

jobs:
  remind:
    runs-on: ubuntu-latest

    steps:
      - name: Notify pending reviewers
        uses: actions/github-script@v7
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            const label = "awaiting review";
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const slackWebhook = process.env.SLACK_WEBHOOK_URL;
            if (!slackWebhook) {
              throw new Error("Missing SLACK_WEBHOOK_URL");
            }

            const prs = await github.paginate(
              github.rest.pulls.list,
              { owner, repo, state: "open" }
            );

            const relevantPRs = prs.filter(pr =>
              pr.labels.some(l => l.name === label)
            );

            if (relevantPRs.length === 0) {
              console.log("No PRs awaiting review");
              return;
            }

            const blocks = [
              {
                type: "context",
                elements: [
                  {
                    type: "image",
                    image_url: "https://api.slack.com/img/blocks/bkb_template_images/notificationsWarningIcon.png",
                    alt_text: "notifications warning icon"
                  },
                  {
                    type: "mrkdwn",
                    text: "*Pending Reviews*"
                  }
                ]
              },
              { type: "divider" }
            ];


            for (const pr of relevantPRs) {
              const reviews = await github.paginate(
                github.rest.pulls.listReviews,
                { owner, repo, pull_number: pr.number }
              );

              const reviewedUsers = new Set(
                reviews.map(r => r.user.login)
              );

              const pendingReviewers = pr.requested_reviewers
                .map(r => r.login)
                .filter(login => !reviewedUsers.has(login));

              if (pendingReviewers.length === 0) continue;

              const mentions = pendingReviewers
                .map(u => `@${u}`)
                .join(", ");

              blocks.push({
                type: "section",
                text: {
                  type: "mrkdwn",
                  text: `*<${pr.html_url}|#${pr.number} â€“ ${pr.title}>*\n${mentions}`
                }
              });
            }

            // Only header blocks = no pending reviewers
            if (blocks.length === 2) {
              console.log("No pending reviewers");
              return;
            }

            blocks.push({ type: "divider" });

            await fetch(slackWebhook, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ blocks })
            });
